<!doctype html>
{% extends 'base.html' %}
{% block title %}Monsterpedia{% endblock %}
{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='statblock.css') }}">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Aclonica|Philospher">
<script src="{{ url_for('static', filename='dice.js') }}"></script>
<script>
    const fs = require('fs');
    // Return number with + if 0 or higher
    function addOperator(num) {
        if (num >= 0) {
            return "+" + num;
        } else {
            return num;
        }
    }
    // Return modifier of score prefixed with + or -
    function getModifier(num) {
        let mod = Math.floor((num - 10) / 2);
        return addOperator(mod)
    }
    // Search json_data for matching monster
    function searchMonsters() {
        let string = document.getElementById('monster_name').value;
        let monsters = JSON.parse(document.getElementById("json_data").innerHTML);
        let stats = monsters[string.toLowerCase()];
        if (stats) {
            let statblock = `<h3>${stats["Name"].toUpperCase()}</h3>
            <p><i>${stats["Size"]}, ${stats["Kind"]}, ${stats["Alignment"]}</i></p>`;
            if (stats["Armour Class"] instanceof Array) {
                statblock += `<p><b>Armour Class</b> ${stats["Armour Class"][0]} (<i>${stats["Armour Class"][1]}</i>)</p>`;
            } else {
                statblock += `<p><b>Armour Class</b> ${stats["Armour Class"]}</p>`;
            }
            statblock += `<p>
                <span><div class="dropdown" id="damage_heal">
                    <button onclick="showDropDown('damDropdown')" class="dropbtn">Hit Points</button>
                    <div id="damDropdown" class="dropdown-content">
                        <button onclick="document.getElementById('hit_points').innerHTML = parseInt(document.getElementById('hit_points').innerHTML) + parseInt(document.getElementById('mod_hp').value)">Heal</button>
                        <button onclick="document.getElementById('hit_points').innerHTML = parseInt(document.getElementById('hit_points').innerHTML) - parseInt(document.getElementById('mod_hp').value)">Damage</button>
                    </div>
                </span>
                <span id="hit_points">${stats["Hit Points"][0]}</span> 
                <span><input type="number" id="mod_hp"></span>
                <span><b id="name">Temp HP</b> <input type="number"></span>
                <span><button onclick="document.getElementById('hit_points').innerHTML = rollString(document.getElementById('hit_dice').innerHTML)">Hit Dice</button> <span id="hit_dice">${stats["Hit Points"][1]}</span></span>            
            </p>
            <p><b id="name">Speed</b> ${stats["Speed"]}</p>
            <table class="abilities_table">
                <tr>
                    <td><div class="dropdown">
                            <button onclick="showDropDown('strDropdown')" class="dropbtn">STR</button>
                            <div id="strDropdown" class="dropdown-content">
                            <button onclick="document.getElementById('str_roll').innerHTML = rollString('d20' + '${getModifier(stats["Abilities"][0])}')">Roll</button>
                            <button onclick="document.getElementById('str_roll').innerHTML = rollAdvan('d20' + '${getModifier(stats["Abilities"][0])}')">Advn</button>
                            <button onclick="document.getElementById('str_roll').innerHTML = rollDisad('d20' + '${getModifier(stats["Abilities"][0])}')">Disad</button>
                        </div>
                    </div>
                    </td>
                    <td><div class="dropdown">
                            <button onclick="showDropDown('dexDropdown')" class="dropbtn">DEX</button>
                            <div id="dexDropdown" class="dropdown-content">
                            <button onclick="document.getElementById('dex_roll').innerHTML = rollString('d20' + '${getModifier(stats["Abilities"][1])}')">Roll</button>
                            <button onclick="document.getElementById('dex_roll').innerHTML = rollAdvan('d20' + '${getModifier(stats["Abilities"][1])}')">Advn</button>
                            <button onclick="document.getElementById('dex_roll').innerHTML = rollDisad('d20' + '${getModifier(stats["Abilities"][1])}')">Disad</button>
                        </div>
                    </div>
                    </td>
                    <td><div class="dropdown">
                            <button onclick="showDropDown('conDropdown')" class="dropbtn">CON</button>
                            <div id="conDropdown" class="dropdown-content">
                            <button onclick="document.getElementById('con_roll').innerHTML = rollString('d20' + '${getModifier(stats["Abilities"][2])}')">Roll</button>
                            <button onclick="document.getElementById('con_roll').innerHTML = rollAdvan('d20' + '${getModifier(stats["Abilities"][2])}')">Advn</button>
                            <button onclick="document.getElementById('con_roll').innerHTML = rollDisad('d20' + '${getModifier(stats["Abilities"][2])}')">Disad</button>
                        </div>
                    </div>
                    </td>
                    <td><div class="dropdown">
                            <button onclick="showDropDown('intDropdown')" class="dropbtn">INT</button>
                            <div id="intDropdown" class="dropdown-content">
                            <button onclick="document.getElementById('int_roll').innerHTML = rollString('d20' + '${getModifier(stats["Abilities"][3])}')">Roll</button>
                            <button onclick="document.getElementById('int_roll').innerHTML = rollAdvan('d20' + '${getModifier(stats["Abilities"][3])}')">Advn</button>
                            <button onclick="document.getElementById('int_roll').innerHTML = rollDisad('d20' + '${getModifier(stats["Abilities"][3])}')">Disad</button>
                        </div>
                    </div>
                    </td>
                    <td><div class="dropdown">
                            <button onclick="showDropDown('wisDropdown')" class="dropbtn">WIS</button>
                            <div id="wisDropdown" class="dropdown-content">
                            <button onclick="document.getElementById('wis_roll').innerHTML = rollString('d20' + '${getModifier(stats["Abilities"][4])}')">Roll</button>
                            <button onclick="document.getElementById('wis_roll').innerHTML = rollAdvan('d20' + '${getModifier(stats["Abilities"][4])}')">Advn</button>
                            <button onclick="document.getElementById('wis_roll').innerHTML = rollDisad('d20' + '${getModifier(stats["Abilities"][4])}')">Disad</button>
                        </div>
                    </div>
                    </td>
                    <td><div class="dropdown">
                            <button onclick="showDropDown('chaDropdown')" class="dropbtn">CHA</button>
                            <div id="chaDropdown" class="dropdown-content">
                            <button onclick="document.getElementById('cha_roll').innerHTML = rollString('d20' + '${getModifier(stats["Abilities"][5])}')">Roll</button>
                            <button onclick="document.getElementById('cha_roll').innerHTML = rollAdvan('d20' + '${getModifier(stats["Abilities"][5])}')">Advn</button>
                            <button onclick="document.getElementById('cha_roll').innerHTML = rollDisad('d20' + '${getModifier(stats["Abilities"][5])}')">Disad</button>
                        </div>
                    </div>
                    </td>
                </tr>
                <tr>
                    <td>${stats['Abilities'][0]}</td>
                    <td>${stats['Abilities'][1]}</td>
                    <td>${stats['Abilities'][2]}</td>
                    <td>${stats['Abilities'][3]}</td>
                    <td>${stats['Abilities'][4]}</td>
                    <td>${stats['Abilities'][5]}</td>
                </tr>
                <tr>
                    <td id="str_mod">${getModifier(stats["Abilities"][0])}</td>
                    <td id="dex_mod">${getModifier(stats["Abilities"][1])}</td>
                    <td id="con_mod">${getModifier(stats["Abilities"][2])}</td>
                    <td id="int_mod">${getModifier(stats["Abilities"][3])}</td>
                    <td id="wis_mod">${getModifier(stats["Abilities"][4])}</td>
                    <td id="cha_mod">${getModifier(stats["Abilities"][5])}</td>
                </tr>
                <tr>
                    <td><span id="str_roll"></span></td>
                    <td><span id="dex_roll"></span></td>
                    <td><span id="con_roll"></span></td>
                    <td><span id="int_roll"></span></td>
                    <td><span id="wis_roll"></span></td>
                    <td><span id="cha_roll"></span></td>
                </tr>
            </table>`;
            if (stats["Saving Throws"]) {
                statblock += `<table>
                    <tr>
                        <td><b>Saving Throws</b></td>`;
                var saves = stats["Saving Throws"];
                for (const save in saves) {
                    statblock += `<td class="dropdown">
                        <button onclick="showDropDown('${save}Dropdown')" class="dropbtn">${save}</button>
                        <div id="${save}Dropdown" class="dropdown-content">
                        <button onclick="document.getElementById('saving_throw').innerHTML = rollString('d20+' + '${saves[save]}')">Roll</button>
                        <button onclick="document.getElementById('saving_throw').innerHTML = rollAdvan('d20+' + '${saves[save]}')">Advn</button>
                        <button onclick="document.getElementById('saving_throw').innerHTML = rollDisad('d20+' + '${saves[save]}')">Disad</button>
                    </div>
                </td>
                <td>${addOperator(saves[save])}</td> `;
                }
                statblock += `<td id="saving_throw"></td>
                    </tr>
                </tabe>`;
            }
            return statblock;
        }
        else {
            return `404 - '${string}' not found.`
        }
    }
    // Display dropdown menus for roll buttons
    function showDropDown(string) {
        document.getElementById(string).classList.toggle("show");
    }
    // Close a dropdown if the user clicks outside of it
    window.onclick = function(event) {
        if (!event.target.matches('.dropbtn')) {
            var dropdowns = document.getElementsByClassName("dropdown-content");
            var i;
            for (i = 0; i < dropdowns.length; i++) {
                var openDropdown = dropdowns[i];
                if (openDropdown.classList.contains('show')) {
                    openDropdown.classList.remove('show');
                }
            }
        }
    }
</script>
{% endblock %}
{% block content %}
<p id="json_data" hidden>{{ monsters }}</p>
<br>
<span id="search area"><input type="text" id="monster_name"><button onclick="document.getElementById('result').innerHTML = searchMonsters()">Search Monsters</button></span>
<div id="result"></div>
{% endblock %}